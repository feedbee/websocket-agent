<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
	<title>Server status â€” WebSockets Agent Client</title>
	<link rel="stylesheet" href="styles.css">
</head>
<body>
<div id="wrapper">
    <div id="header">
        <h1>WebSockets Agent Client</h1>
        <button id="connect">Connect</button> <button id="start">Start</button> <button id="stop">Stop</button> 
        <input id="interval-value" type="text" style="width:40px;" value="1" /> <button id="interval">Set interval</button> 
        <button id="disconnect">Disconnect</button>
    <div id="processors">
		<canvas id="processors-cpu0" width="300" height="20"></canvas> <span id="processors-cpu0-value"></span><br />
		<canvas id="processors-cpu1" width="300" height="20"></canvas> <span id="processors-cpu1-value"></span><br />
		<canvas id="processors-cpu2" width="300" height="20"></canvas> <span id="processors-cpu2-value"></span><br />
		<canvas id="processors-cpu3" width="300" height="20"></canvas> <span id="processors-cpu3-value"></span><br />
    </div>
    <div id="memory">
    	<canvas id="memory-canvas" width="300" height="20"></canvas> <span id="memory-value"></span><br />
    </div>
    <div id="swap">
    	<canvas id="swap-canvas" width="300" height="20"></canvas> <span id="swap-value"></span><br />
    </div>
    </div><!-- #header -->
</div>
<script src="client.js"></script>

<script>
	var types = [
		{key: 'iowait',  color: "rgb(80,20,170)"},
		{key: 'system',  color: "rgb(10,150,20)"},
		{key: 'user', color: "rgb(160,20,0)"}
	];
	var f = function (allCpus) {
		for (key in allCpus)
		{
			data = allCpus[key];

			var canvas = $('#processors-' + key).get(0);
			var valueField = $('#processors-' + key + '-value');
			var ctx = canvas.getContext("2d");

			ctx.clearRect(0, 0, canvas.width, canvas.height);

			var lastX = 0;
			var width = canvas.width;
			types.forEach(function(element) {
				var value = data[element.key];
				ctx.fillStyle = element.color;
				var segmentWidth = Math.round(value * width);
				ctx.fillRect(lastX, 0, segmentWidth, canvas.height);
				lastX += segmentWidth;
			});

			valueField.text(Math.round(data.usage * 1000) / 10 + ' %');
		}
	};

	var typesMemory = [
		{key: 'apps',    color: "rgb(10,150,20)"},
		{key: 'buffers', color: "rgb(160,20,0)"},
		{key: 'cached',  color: "rgb(80,20,170)"}
	];
	var f2 = function (meminfo) {
		for (key in meminfo)
		{
			data = meminfo[key];

			if (!data.buffers)
			{
				data.buffers = 0;
			}
			data.apps = data.used - data.cached - data.buffers;

			var canvas = $('#' + key + '-canvas').get(0);
			var valueField = $('#' + key + '-value');
			var ctx = canvas.getContext("2d");

			ctx.clearRect(0, 0, canvas.width, canvas.height);

			var lastX = 0;
			var width = canvas.width;
			typesMemory.forEach(function(element) {
				var value = data[element.key];
				ctx.fillStyle = element.color;
				segmentWidth = Math.round(value / data.total * width);
				ctx.fillRect(lastX, 0, segmentWidth, canvas.height);
				lastX = lastX + segmentWidth;
			});

			valueField.text(Math.round(data.used / data.total * 1000) / 10 + ' %');
		}
	};
	var client = new AgentServerClient(function (msg) {
		var jsonResponce = JSON.parse(msg);
		f(jsonResponce.cpu_stat);
		f2(jsonResponce.meminfo);
	});

	$('#connect').on('click', client.connect);
	$('#start').on('click', client.start);
	$('#stop').on('click', client.stop);
	$('#interval').on('click', function () {client.setInterval($('#interval-value').val());});
	$('#disconnect').on('click', client.disconnect);
</script>
</body>
</html>